# py-rule 项目逻辑梳理文档

## 一、项目概述

`py-rule` 是一个基于 Python 的规则引擎项目，用于定义、转换和执行条件规则。项目采用模块化设计，将条件定义、表达式生成、运行时执行等功能分离，支持复杂的条件判断、数据加载和诊断评估。

### 核心功能
1. **条件定义**：支持单条件和组合条件（AND/OR/NOT）
2. **表达式生成**：将条件转换为可执行的 Python 表达式字符串
3. **运行时执行**：支持数据加载、条件评估、诊断分析
4. **类型系统**：支持多种值类型（整数、字符串、时间、群组等）

---

## 二、项目结构

```
py-rule/
├── condition/          # 条件定义模块
├── expr/               # 表达式生成模块
├── runtime/            # 运行时执行模块
└── examples/           # 使用示例
```

---

## 三、模块详细说明

### 3.1 condition 模块 - 条件定义核心

#### 3.1.1 condition.py
**核心作用**：定义 `Condition` 类，作为整个规则引擎的基础数据结构。

**主要功能**：
- **条件表示**：
  - 单字段条件：`field`（字段名）、`op`（操作符）、`val`（值）、`val_type`（值类型）
  - 组合条件：`join_op`（连接符 AND/OR/NOT）、`conditions`（子条件列表）
- **条件操作**：
  - `is_empty()`：判断条件是否为空
  - `is_join()`：判断是否为组合条件
  - `is_always_true()` / `is_always_false()`：判断是否为恒真/恒假条件
  - `clone()`：克隆条件
  - `equals()`：比较两个条件是否相等
  - `not_()`：条件取反
  - `simplify()`：简化条件表达式
  - `transform_forward()`：正向转换条件（如 NE 转换为 NOT EQ）
- **工具函数**：
  - `And(*conditions)`：创建 AND 组合条件
  - `Or(*conditions)`：创建 OR 组合条件
  - `Not(cond)`：创建 NOT 条件
  - `IsEmpty(c)`：判断条件是否为空
  - `NewAlwaysTrue()` / `NewAlwaysFalse()`：创建恒真/恒假条件

**使用示例**：
```python
# 单条件
cond1 = Condition("age", Op.GT, "18", ValType.INT)

# 组合条件
cond2 = And(
    Condition("age", Op.GT, "18", ValType.INT),
    Condition("name", Op.EQ, "张三", ValType.STRING)
)
```

---

#### 3.1.2 op.py
**核心作用**：定义操作符和连接符枚举。

**主要功能**：
- **Op 枚举**：比较操作符
  - `EQ`：等于
  - `NE`：不等于（会转换为 NOT EQ）
  - `LT` / `LTE`：小于 / 小于等于
  - `GT` / `GTE`：大于 / 大于等于
  - `IN`：包含于
  - `CONTAINS_ANY`：包含任意元素
  - 提供 `code()` 方法返回操作符字符串（如 "==", ">", "in"）
  - 提供 `forward_op()` 方法进行正向转换
- **JoinOp 枚举**：逻辑连接符
  - `AND`：逻辑与
  - `OR`：逻辑或
  - `NOT`：逻辑非
  - 提供 `code()` 方法返回连接符字符串（如 "and", "or", "not"）

---

#### 3.1.3 var.py
**核心作用**：定义值类型枚举和相关工具类。

**主要功能**：
- **ValType 枚举**：值类型定义
  - `INT = 1`：整型
  - `STRING = 2`：字符串
  - `BOOL = 3`：布尔
  - `FLOAT = 4`：浮点
  - `TIME = 8`：时间
  - `TIME_BEFORE = 9`：现在之前（相对时间）
  - `TIME_AFTER = 10`：现在之后（相对时间）
  - `BI_CROWD = 11`：BI人群包
  - `GROUP = 12`：群组
  - `VAR = 13`：变量（引用表达式环境字段）
- **ValAndType 类**：值和类型组合
  - `code()`：获取类型代码
  - `text()`：获取类型文本描述

---

#### 3.1.4 func.py
**核心作用**：提供条件表达式中使用的函数实现。

**主要功能**：
- **时间函数**：
  - `add_period_func()`：时间加减函数，支持秒/分/时/天单位
  - `today_func()`：获取当前日期（时分秒为0）
- **包含判断**：
  - `contains_any_func()`：判断源列表是否包含目标列表中的任意元素
    - 支持关键词模式（字符串包含）
    - 支持非关键词模式（集合交集）
- **零值判断**：
  - `is_not_zero_func()`：判断值是否非零/非空
- **群组函数**：
  - `in_groups_func(*in_groupers)`：判断值是否在指定群组中
  - `in_bi_crowd_func(key_prefix, redis_client)`：判断用户是否在BI人群包中

**函数签名**：所有函数返回 `(name: str, fn: Callable)` 元组，用于注册到表达式执行环境。

---

#### 3.1.5 context.py
**核心作用**：定义上下文类，用于存储和获取键值对数据。

**主要功能**：
- **线程安全存储**：使用 `threading.RLock` 保证线程安全
- **基础操作**：
  - `set(key, value)`：设置键值对
  - `get(key)`：获取值，返回 `(value, exists)` 元组
- **类型化获取**：
  - `get_string(key)`：获取字符串值
  - `get_bool(key)`：获取布尔值
  - `get_int64(key)`：获取整数值
- **上下文支持**：支持基于现有上下文创建新上下文

---

#### 3.1.6 values.py
**核心作用**：提供值处理工具函数。

**主要功能**：
- `unquote(val)`：去除字符串首尾的引号（单引号或双引号）
- `val_to_int64_slice(val)`：将字符串转换为整数列表
  - 支持 JSON 数组格式：`"[1,2,3]"`
  - 支持逗号分隔格式：`"1,2,3"`
  - 支持单个值：`"1"`
- `val_to_string_slice(val)`：将字符串转换为字符串列表
  - 支持格式同上

---

#### 3.1.7 in_group.py
**核心作用**：定义群组匹配接口和实现。

**主要功能**：
- **InGrouper 接口**：
  - `match(ctx, field_val_str, params)`：判断是否由该实现处理
  - `key(ctx, field_val_str, params)`：生成 Redis key
  - `in_groups(ctx, field_val_str, params_list)`：判断是否在群组中
- **InRedisGroup 实现**：
  - 通过 Redis key 的 TTL 实现群组判断
  - 支持时间范围判断（afterAt/beforeAt）
  - 支持批量查询优化
  - 使用上下文变量缓存查询结果

---

#### 3.1.8 meta.py
**核心作用**：定义条件元数据，描述字段支持的操作符、值类型等信息。

**主要功能**：
- **Meta 类**：字段元信息
  - `field`：字段名
  - `name`：字段显示名称
  - `support_val_types`：支持的值类型列表
  - `support_ops`：支持的操作符列表
  - `support_values`：可选值列表
  - `keyword`：是否允许关键词匹配
  - `required`：值是否必须
- **MetaValue 类**：可选值描述
  - `val`：值
  - `val_type`：值类型
  - `name`：值名称
  - `period_unit`：时间单位（用于相对时间）

---

#### 3.1.9 selector.py
**核心作用**：定义选择器接口，用于筛选条件。

**主要功能**：
- **Selector 接口**：提供 `match(condition)` 方法判断条件是否符合筛选规则
- **DefaultSelector 实现**：
  - 支持按包含字段筛选
  - 支持按排除字段筛选
  - 支持自定义谓词筛选
- **工具函数**：
  - `join_selector(*selectors)`：组合多个选择器（AND）
  - `not_selector(selector)`：取反选择器

---

#### 3.1.10 convert.py
**核心作用**：提供条件表达式转换功能。

**主要功能**：
- **ConvertMapping 类**：定义字段和值的映射关系
  - 支持字段映射（源字段 → 目标字段）
  - 支持值映射（源值 → 目标值）
- **convert_condition 函数**：递归转换条件
  - 支持多转换器组合
  - 支持字段和值的转换

---

#### 3.1.11 utils.py
**核心作用**：提供通用工具函数。

**主要功能**：
- `is_collection(obj)`：判断对象是否为集合类型（列表、元组等，排除字符串）
- `is_empty(obj)`：判断对象是否为空（None、空集合等）

---

### 3.2 expr 模块 - 表达式生成

#### 3.2.1 expr.py
**核心作用**：将 `Condition` 对象转换为可执行的 Python 表达式字符串。

**主要功能**：
- **ExpressionBuilder 类**：
  - `build_expression(condition)`：构建表达式字符串
  - `_build_expr(condition, result)`：递归构建表达式
  - `_build_join_expression(condition, result)`：构建连接表达式（AND/OR/NOT）
  - `_build_single_expression(condition, result)`：构建单个条件表达式
- **处理流程**：
  1. 正向转换：`transform_forward()`（如 NE → NOT EQ）
  2. 简化：`simplify()`（如双重否定）
  3. 递归构建表达式字符串
- **expr 函数**：全局函数，调用 `ExpressionBuilder` 生成表达式

**表达式示例**：
```python
# 条件
cond = And(
    Condition("age", Op.GT, "18", ValType.INT),
    Condition("name", Op.EQ, "张三", ValType.STRING)
)

# 生成的表达式
# "((age>18)and(name==\"张三\"))"
```

---

#### 3.2.2 value_handle/ - 值类型处理器

**核心作用**：根据不同的值类型，生成对应的表达式片段。

**架构设计**：
- **策略模式**：每种值类型对应一个处理器
- **工厂模式**：`HandlerFactory` 管理所有处理器

#### 3.2.2.1 base_handler.py
**核心作用**：定义处理器抽象基类。

**接口定义**：
- `supports(val_type)`：判断是否支持该值类型
- `build_expression(condition, result)`：构建表达式片段
- `generate_suggestions(condition, actual_value)`：生成修改建议（用于诊断）
- `_get_field_expression(field)`：获取字段表达式（处理字段名后的 `()`）

---

#### 3.2.2.2 factory.py
**核心作用**：处理器工厂，管理所有值类型处理器。

**主要功能**：
- **注册处理器**：自动注册所有内置处理器
  - `IntHandler`：整型处理器
  - `StringHandler`：字符串处理器
  - `FloatHandler`：浮点处理器
  - `BoolHandler`：布尔处理器
  - `TimeHandler`：时间处理器
  - `TimeBeforeHandler`：之前时间处理器
  - `TimeAfterHandler`：之后时间处理器
  - `VarHandler`：变量处理器
  - `GroupHandler`：群组处理器
  - `BICrowdHandler`：BI人群包处理器
- **获取处理器**：`get_handler(val_type)` 根据值类型获取对应处理器
- **注册新处理器**：`register_handler(handler)` 支持扩展
- **生成建议**：`get_suggestions(condition, actual_value)` 用于诊断评估

---

#### 3.2.2.3 各类型处理器

**IntHandler** (`int_handler.py`)：
- 支持操作符：`EQ`, `LT`, `LTE`, `GT`, `GTE`, `IN`, `CONTAINS_ANY`
- 表达式示例：
  - `EQ`: `age==18`
  - `IN`: `age in [1,2,3]`
  - `CONTAINS_ANY`: `ContainsAny(age, [1,2,3], false)`

**StringHandler** (`string_handler.py`)：
- 支持操作符：`EQ`, `LT`, `LTE`, `GT`, `GTE`, `IN`, `CONTAINS_ANY`
- 字符串值会自动添加引号
- 表达式示例：`name=="张三"`

**FloatHandler** (`float_handler.py`)：
- 支持操作符：`LT`, `LTE`, `GT`, `GTE`（不支持 EQ，浮点数比较应使用范围）
- 表达式示例：`score>85.5`

**BoolHandler** (`bool_handler.py`)：
- 支持操作符：`EQ`
- 表达式示例：`is_active==true`

**TimeHandler** (`time_handler.py`)：
- 支持操作符：`EQ`, `LT`, `LTE`, `GT`, `GTE`
- 使用 `date()` 函数包装时间值
- 表达式示例：`created_at>date("2024-01-01")`

**TimeBeforeHandler** (`time_before_handler.py`)：
- 支持操作符：`EQ`, `LT`, `LTE`, `GT`, `GTE`
- 使用 `AddPeriod(now(), -duration, unit)` 计算相对时间
- 验证 `period_unit` 有效性（2=秒, 3=分, 4=小时, 5=天）
- 表达式示例：`created_at>AddPeriod(now(), -7, 5)`（7天前）

**TimeAfterHandler** (`time_after_handler.py`)：
- 支持操作符：`EQ`, `LT`, `LTE`, `GT`, `GTE`
- 使用 `AddPeriod(now(), duration, unit)` 计算相对时间
- 验证 `period_unit` 有效性
- 表达式示例：`created_at<AddPeriod(now(), 7, 5)`（7天后）

**VarHandler** (`var_handler.py`)：
- 支持操作符：`EQ`, `LT`, `LTE`, `GT`, `GTE`, `IN`, `CONTAINS_ANY`
- 变量值直接引用表达式环境中的字段
- 表达式示例：`age>other_age`

**GroupHandler** (`group_handler.py`)：
- 支持操作符：`IN`
- 使用 `InGroups(Context, field, [group1], [group2], ...)` 函数
- 解析 JSON 格式的群组值
- 表达式示例：`InGroups(Context, userId, ["group1"], ["group2"])`

**BICrowdHandler** (`bi_crowd_handler.py`)：
- 支持操作符：`IN`
- 使用 `InBICrowd(Context, userId, [crowd1, crowd2, ...])` 函数
- 表达式示例：`InBICrowd(Context, userId, [1,2,3])`

---

### 3.3 runtime 模块 - 运行时执行

#### 3.3.1 executor.py
**核心作用**：执行器，负责条件评估和数据加载的协调。

**主要功能**：
- **Executor 类**：
  - `__init__(condition, loaders, env_type)`：初始化执行器
    - `condition`：要执行的条件
    - `loaders`：数据加载器列表（按优先级排序）
    - `env_type`：环境对象类型
  - `execute(items)`：执行条件评估
    - 按加载器顺序加载数据
    - 对每个项目进行条件评估
    - 返回执行结果
- **ExecutedResult 类**：执行结果
  - `matched_items`：匹配的项目列表
  - `not_matched_items`：不匹配的项目列表
  - `unloaded_items`：未加载的项目列表
- **ExecutedItem 类**：执行项
  - `item`：项目对象
  - `reason`：不匹配原因（可选）

**执行流程**：
1. 遍历所有加载器，按顺序加载数据
2. 收集未加载的项目
3. 对已加载的项目进行条件评估
4. 返回匹配和不匹配的项目列表

---

#### 3.3.2 loader.py
**核心作用**：定义数据加载器接口。

**主要功能**：
- **Loader 基类**：
  - `name`：加载器名称
  - `cost`：加载成本（用于优先级排序）
  - `load(condition, items)`：加载数据
    - 返回未加载的项目列表
    - 已加载的项目会被修改（填充数据）

**使用方式**：继承 `Loader` 类，实现 `load` 方法。

---

#### 3.3.3 evaluator.py
**核心作用**：定义评估器接口。

**主要功能**：
- **Evaluator 类**：
  - `__init__(condition, evaluate_func)`：初始化评估器
  - `evaluate(env)`：评估条件，返回布尔值

**使用方式**：传入条件和评估函数，提供统一的评估接口。

---

#### 3.3.4 DiagnosticEvaluator.py
**核心作用**：诊断评估器，提供详细的评估信息和修改建议。

**主要功能**：
- **DiagnosticEvaluator 类**：
  - `__init__(functions)`：初始化，传入表达式函数字典
  - `evaluate_with_diagnostics(condition, env)`：带诊断的评估
    - 返回 `(result, diagnostics)` 元组
    - `result`：评估结果（布尔值）
    - `diagnostics`：诊断信息列表
- **诊断信息结构**：
  ```python
  {
      "condition": Condition,      # 条件对象
      "passed": bool,              # 是否通过
      "actual_value": Any,         # 实际值
      "suggestions": List[str],    # 修改建议
      "error": str                 # 错误信息（如果有）
  }
  ```
- **print_diagnostics 函数**：打印诊断结果，格式化输出

**使用场景**：当条件不满足时，提供详细的失败原因和修改建议。

---

### 3.4 examples 模块 - 使用示例

#### 3.4.1 expr_example.py
**核心作用**：演示表达式生成和诊断评估的使用。

**示例内容**：
- 创建组合条件（AND）
- 生成表达式字符串
- 使用 `DiagnosticEvaluator` 进行评估
- 打印诊断信息

**关键代码**：
```python
# 创建条件
cond = Condition()
cond.join_op = JoinOp.AND
cond.conditions = [
    Condition("Id", Op.EQ, "1", ValType.INT),
    Condition("Name()", Op.EQ, "A Mao", ValType.STRING),
    Condition("month", Op.CONTAINS_ANY, "[3,7,11]", ValType.INT)
]

# 生成表达式
expr_str = expr(cond)

# 诊断评估
evaluator = DiagnosticEvaluator(functions)
result, diagnostics = evaluator.evaluate_with_diagnostics(cond, env)
```

---

#### 3.4.2 loaders_example.py
**核心作用**：演示执行器和加载器的使用。

**示例内容**：
- 定义自定义加载器（继承 `Loader`）
- 创建执行器执行条件
- 处理执行结果

**关键代码**：
```python
# 自定义加载器
class BaseLoader(Loader):
    async def load(self, condition, items):
        # 加载数据逻辑
        return []

# 创建执行器
executor = Executor(cond, loaders, Actor)

# 执行
result = await executor.execute(items)
```

---

## 四、数据流和调用链

### 4.1 表达式生成流程

```
Condition 对象
    ↓
transform_forward()  # 正向转换（NE → NOT EQ）
    ↓
simplify()          # 简化表达式
    ↓
ExpressionBuilder.build_expression()
    ↓
递归构建表达式字符串
    ↓
HandlerFactory.get_handler()  # 根据值类型获取处理器
    ↓
Handler.build_expression()    # 生成表达式片段
    ↓
Python 表达式字符串
```

### 4.2 条件评估流程

```
Condition 对象
    ↓
expr() 生成表达式字符串
    ↓
准备执行环境（env + functions）
    ↓
eval(expr_str, functions, env)
    ↓
返回布尔结果
```

### 4.3 执行器流程

```
Executor.execute(items)
    ↓
遍历 Loaders
    ↓
loader.load(condition, items)  # 加载数据
    ↓
过滤已加载项
    ↓
evaluator(item)  # 评估条件
    ↓
分类结果（matched / not_matched / unloaded）
    ↓
返回 ExecutedResult
```

### 4.4 诊断评估流程

```
DiagnosticEvaluator.evaluate_with_diagnostics()
    ↓
遍历子条件
    ↓
单独评估每个条件
    ↓
获取实际值
    ↓
Handler.generate_suggestions()  # 生成建议
    ↓
收集诊断信息
    ↓
返回 (result, diagnostics)
```

---

## 五、关键设计模式

### 5.1 策略模式
- **值类型处理器**：每种值类型对应一个处理器类
- **选择器**：不同的筛选策略

### 5.2 工厂模式
- **HandlerFactory**：管理所有值类型处理器
- **函数工厂**：`add_period_func()`, `contains_any_func()` 等

### 5.3 模板方法模式
- **Loader 基类**：定义加载流程，子类实现具体逻辑

### 5.4 组合模式
- **Condition 类**：支持条件组合（AND/OR/NOT）

---

## 六、扩展点

### 6.1 添加新的值类型
1. 在 `ValType` 枚举中添加新类型
2. 创建对应的 Handler 类（继承 `ValueHandler`）
3. 在 `HandlerFactory` 中注册新处理器

### 6.2 添加新的操作符
1. 在 `Op` 枚举中添加新操作符
2. 实现 `code()` 和 `forward_op()` 方法
3. 在相关 Handler 中添加支持

### 6.3 添加新的函数
1. 在 `func.py` 中实现函数（返回 `(name, fn)` 元组）
2. 在表达式执行环境中注册函数

### 6.4 添加新的加载器
1. 继承 `Loader` 类
2. 实现 `load()` 方法
3. 在 `Executor` 中使用

---

## 七、注意事项

### 7.1 线程安全
- `Context` 类使用 `threading.RLock` 保证线程安全
- 其他模块未做线程安全处理，多线程使用时需注意

### 7.2 表达式安全
- 使用 `eval()` 执行表达式，需确保表达式来源可信
- 建议在生产环境中限制表达式复杂度

### 7.3 性能考虑
- 表达式生成是一次性的，可缓存结果
- 数据加载器支持批量加载，减少 IO 次数
- Redis 查询使用 Pipeline 优化

### 7.4 错误处理
- 各模块都有基本的错误处理
- 建议在生产环境中添加更完善的异常捕获和日志记录

---

## 八、与 Go 版本的对应关系

本项目是 Go 版本 `go-rule` 的 Python 实现，主要对应关系：

| Python 模块 | Go 模块 | 说明 |
|------------|---------|------|
| `condition/` | `condition/` | 条件定义模块，功能基本一致 |
| `expr/` | `expr/` | 表达式生成模块，功能基本一致 |
| `runtime/` | `runtime/` | 运行时执行模块，Python 版本简化实现 |
| `value_handle/` | `expr.go` 中的 switch-case | 值类型处理，Python 使用策略模式 |

---

## 九、总结

`py-rule` 项目是一个功能完整的规则引擎，采用模块化设计，支持：
- ✅ 灵活的条件定义和组合
- ✅ 多种值类型和操作符
- ✅ 表达式生成和评估
- ✅ 数据加载和诊断分析
- ✅ 易于扩展的架构设计

项目代码结构清晰，职责分离明确，适合用于规则配置、条件筛选、数据过滤等场景。

