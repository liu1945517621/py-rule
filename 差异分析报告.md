# Go ä¸ Python é¡¹ç›® ValType å¤„ç†å·®å¼‚åˆ†ææŠ¥å‘Š

## ä¸€ã€æ€»ä½“å¯¹æ¯”

### 1.1 ValType ç±»å‹è¦†ç›–æƒ…å†µ

**Go é¡¹ç›®æ”¯æŒçš„ ValTypeï¼ˆä» expr.go åˆ†æï¼‰ï¼š**
- âœ… ValTypeInt (1)
- âœ… ValTypeFloat (4)
- âœ… ValTypeVar (13)
- âœ… ValTypeBool (3)
- âœ… ValTypeString (2)
- âœ… ValTypeTime (8)
- âœ… ValTypeTimeBefore (9)
- âœ… ValTypeTimeAfter (10)
- âœ… ValTypeBICrowd (11)
- âœ… ValTypeGroup (12)

**Python é¡¹ç›®æ”¯æŒçš„ ValTypeï¼ˆä» value_handle åˆ†æï¼‰ï¼š**
- âœ… ValType.INT (1) - IntHandler
- âœ… ValType.FLOAT (4) - FloatHandler
- âœ… ValType.VAR (13) - VarHandler
- âœ… ValType.BOOL (3) - BoolHandler
- âœ… ValType.STRING (2) - StringHandler
- âœ… ValType.TIME (8) - TimeHandler
- âœ… ValType.TIME_BEFORE (9) - TimeBeforeHandler
- âœ… ValType.TIME_AFTER (10) - TimeAfterHandler
- âœ… ValType.BI_CROWD (11) - BICrowdHandler
- âœ… ValType.GROUP (12) - GroupHandler

**ç»“è®ºï¼š** âœ… æ‰€æœ‰ ValType ç±»å‹åœ¨ä¸¤ä¸ªé¡¹ç›®ä¸­éƒ½æœ‰å¯¹åº”çš„å¤„ç†å™¨ï¼Œè¦†ç›–å®Œæ•´ã€‚

---

## äºŒã€è¯¦ç»†å·®å¼‚åˆ†æ

### 2.1 TimeBeforeHandler å’Œ TimeAfterHandler çš„å·®å¼‚

#### å·®å¼‚ 1ï¼šperiod_unit çš„éªŒè¯é€»è¾‘

**Go ä»£ç ï¼ˆexpr.go:181-184, 195-198ï¼‰ï¼š**
```go
if (!funk.Contains(period.AllUnits, c.PeriodUnit)) || c.PeriodUnit == period.UnitNone {
    err = fmt.Errorf("invalid condition:unsupported period unit %d", c.PeriodUnit)
    return
}
```

**Python ä»£ç ï¼š**
- âŒ **ç¼ºå¤±**ï¼š`time_before_handler.py` å’Œ `time_after_handler.py` ä¸­éƒ½æ²¡æœ‰å¯¹ `period_unit` è¿›è¡ŒéªŒè¯

**å»ºè®®ï¼š**
- åœ¨ `TimeBeforeHandler.build_expression()` å’Œ `TimeAfterHandler.build_expression()` æ–¹æ³•å¼€å§‹æ—¶æ·»åŠ  `period_unit` éªŒè¯
- éœ€è¦å®šä¹‰ `AllUnits` åˆ—è¡¨å’Œ `UnitNone` å¸¸é‡ï¼ˆå¦‚æœ Python é¡¹ç›®ä¸­æœ‰å¯¹åº”çš„ period æ¨¡å—ï¼‰
- éªŒè¯å¤±è´¥æ—¶åº”æŠ›å‡º `ValueError`ï¼Œæ ¼å¼ä¸ Go ä»£ç ä¿æŒä¸€è‡´

#### å·®å¼‚ 2ï¼šAddPeriod å‡½æ•°å‚æ•°æ ¼å¼

**Go ä»£ç ï¼ˆexpr.go:189, 203ï¼‰ï¼š**
```go
// TimeBefore
builder.WriteString(fmt.Sprintf("AddPeriod(now(),-%s,%d)", condition.Unquote(c.Val), c.PeriodUnit.Code()))

// TimeAfter
builder.WriteString(fmt.Sprintf("AddPeriod(now(),%s,%d)", condition.Unquote(c.Val), c.PeriodUnit.Code()))
```

**Python ä»£ç ï¼ˆtime_before_handler.py:21, time_after_handler.py:21ï¼‰ï¼š**
```python
# TimeBefore
result.append(f"AddPeriod(now(), -{unquote(c.val)}, {c.period_unit})")

# TimeAfter
result.append(f"AddPeriod(now(), {unquote(c.val)}, {c.period_unit})")
```

**å·®å¼‚ç‚¹ï¼š**
1. **period_unit å¤„ç†æ–¹å¼**ï¼š
   - Go: `c.PeriodUnit.Code()` - è°ƒç”¨ Code() æ–¹æ³•
   - Python: `c.period_unit` - ç›´æ¥ä½¿ç”¨æ•´æ•°
   - âš ï¸ **éœ€è¦ç¡®è®¤**ï¼šPython ä¸­çš„ `period_unit` æ˜¯å¦å·²ç»æ˜¯æ­£ç¡®çš„ä»£ç å€¼ï¼Œè¿˜æ˜¯éœ€è¦è½¬æ¢

2. **è´Ÿæ•°è¡¨ç¤ºæ–¹å¼**ï¼š
   - Go: `-%s` - åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­å¤„ç†
   - Python: `-{unquote(c.val)}` - åœ¨ f-string ä¸­å¤„ç†
   - âœ… **ä¸€è‡´**ï¼šä¸¤ç§æ–¹å¼ç»“æœç›¸åŒ

**å»ºè®®ï¼š**
- ç¡®è®¤ Python é¡¹ç›®ä¸­ `period_unit` çš„å€¼æ˜¯å¦ä¸ Go é¡¹ç›®ä¸­ `PeriodUnit.Code()` çš„è¿”å›å€¼ä¸€è‡´
- å¦‚æœä¸ä¸€è‡´ï¼Œéœ€è¦æ·»åŠ è½¬æ¢é€»è¾‘æˆ–åˆ›å»º PeriodUnit æšä¸¾ç±»

---

### 2.2 IntHandler çš„å·®å¼‚

#### å·®å¼‚ 3ï¼šOpEq æ“ä½œç¬¦æ”¯æŒ

**Go ä»£ç ï¼ˆexpr.go:70ï¼‰ï¼š**
```go
case condition.OpEq, condition.OpLt, condition.OpLte, condition.OpGt, condition.OpGte:
```

**Python ä»£ç ï¼ˆint_handler.py:18ï¼‰ï¼š**
```python
if c.op in [Op.EQ, Op.LT, Op.LTE, Op.GT, Op.GTE]:
```

**ç»“è®ºï¼š** âœ… å®Œå…¨ä¸€è‡´ï¼Œéƒ½æ”¯æŒ OpEq/EQ

---

### 2.3 FloatHandler çš„å·®å¼‚

**Go ä»£ç ï¼ˆexpr.go:94ï¼‰ï¼š**
```go
case condition.OpLt, condition.OpLte, condition.OpGt, condition.OpGte:
```

**Python ä»£ç ï¼ˆfloat_handler.py:18ï¼‰ï¼š**
```python
if c.op in [Op.LT, Op.LTE, Op.GT, Op.GTE]:
```

**ç»“è®ºï¼š** âœ… å®Œå…¨ä¸€è‡´ï¼Œéƒ½ä¸æ”¯æŒ OpEqï¼ˆè¿™æ˜¯æ­£ç¡®çš„ï¼Œæµ®ç‚¹æ•°æ¯”è¾ƒåº”è¯¥ä½¿ç”¨èŒƒå›´æ¯”è¾ƒï¼‰

---

### 2.4 VarHandler çš„å·®å¼‚

**Go ä»£ç ï¼ˆexpr.go:104, 108, 114ï¼‰ï¼š**
```go
case condition.OpEq, condition.OpLt, condition.OpLte, condition.OpGt, condition.OpGte:
    // ...
case condition.OpIn:
    // ...
case condition.OpContainsAny:
    // ...
```

**Python ä»£ç ï¼ˆvar_handler.py:18, 22, 28ï¼‰ï¼š**
```python
if c.op in [Op.EQ, Op.LT, Op.LTE, Op.GT, Op.GTE]:
    // ...
elif c.op == Op.IN:
    // ...
elif c.op == Op.CONTAINS_ANY:
    // ...
```

**ç»“è®ºï¼š** âœ… å®Œå…¨ä¸€è‡´

---

### 2.5 StringHandler çš„å·®å¼‚

**Go ä»£ç ï¼ˆexpr.go:138, 144, 150ï¼‰ï¼š**
```go
case condition.OpEq, condition.OpLt, condition.OpLte, condition.OpGt, condition.OpGte:
    builder.WriteString("\"")
    builder.WriteString(condition.Unquote(c.Val))
    builder.WriteString("\"")
case condition.OpIn:
    builder.WriteString(c.Val)  // ç›´æ¥ä½¿ç”¨ï¼Œä¸æ·»åŠ å¼•å·
case condition.OpContainsAny:
    builder.WriteString(c.Val)  // ç›´æ¥ä½¿ç”¨ï¼Œä¸æ·»åŠ å¼•å·
```

**Python ä»£ç ï¼ˆstring_handler.py:18, 24, 30ï¼‰ï¼š**
```python
if c.op in [Op.EQ, Op.LT, Op.LTE, Op.GT, Op.GTE]:
    result.append("\"")
    result.append(unquote(c.val))
    result.append("\"")
elif c.op == Op.IN:
    result.append(c.val)  # ç›´æ¥ä½¿ç”¨ï¼Œä¸æ·»åŠ å¼•å·
elif c.op == Op.CONTAINS_ANY:
    result.append(c.val)  # ç›´æ¥ä½¿ç”¨ï¼Œä¸æ·»åŠ å¼•å·
```

**ç»“è®ºï¼š** âœ… å®Œå…¨ä¸€è‡´

---

### 2.6 BICrowdHandler çš„å·®å¼‚

**Go ä»£ç ï¼ˆexpr.go:210-218ï¼‰ï¼š**
```go
case condition.OpIn:
    builder.WriteString("InBICrowd(Context, ")
    builder.WriteString(c.Field)
    builder.WriteString(", ")
    err = writeIntSliceForExpr(builder, c.Val)
    builder.WriteString(")")
```

**Python ä»£ç ï¼ˆbi_crowd_handler.py:18-23ï¼‰ï¼š**
```python
if c.op == Op.IN:
    result.append("InBICrowd(Context, ")
    result.append(field_expr)
    result.append(", ")
    self._write_int_slice_for_expr(result, c.val)
    result.append(")")
```

**å·®å¼‚ç‚¹ï¼š**
- Go: ä½¿ç”¨ `c.Field` ç›´æ¥
- Python: ä½¿ç”¨ `field_expr = self._get_field_expression(c.field)` å¤„ç†
- âœ… **Python æ›´å®Œå–„**ï¼š`_get_field_expression` æ–¹æ³•å¯ä»¥å¤„ç†å­—æ®µååçš„ `()` åç¼€

**ç»“è®ºï¼š** âœ… Python å®ç°æ›´å®Œå–„

---

### 2.7 GroupHandler çš„å·®å¼‚

**Go ä»£ç ï¼ˆexpr.go:225-242ï¼‰ï¼š**
```go
case condition.OpIn:
    builder.WriteString("InGroups(Context, ")
    builder.WriteString(c.Field)
    builder.WriteString(", ")
    var values []string
    err = json.Unmarshal([]byte(c.Val), &values)
    if err != nil {
        return
    }
    for i, value := range values {
        if i > 0 {
            builder.WriteString(", ")
        }
        builder.WriteString("[")
        builder.WriteString(value)
        builder.WriteString("]")
    }
    builder.WriteString(")")
```

**Python ä»£ç ï¼ˆgroup_handler.py:18-29ï¼‰ï¼š**
```python
if c.op == Op.IN:
    result.append("InGroups(Context, ")
    result.append(field_expr)
    result.append(", ")
    values = json.loads(c.val)
    for i, value in enumerate(values):
        if i > 0:
            result.append(", ")
        result.append("[")
        result.append(value)
        result.append("]")
    result.append(")")
```

**å·®å¼‚ç‚¹ï¼š**
1. **é”™è¯¯å¤„ç†**ï¼š
   - Go: æ£€æŸ¥ `json.Unmarshal` çš„é”™è¯¯å¹¶è¿”å›
   - Python: âŒ **ç¼ºå¤±**ï¼šæ²¡æœ‰å¯¹ `json.loads` è¿›è¡Œ try-except å¤„ç†

2. **å­—æ®µå¤„ç†**ï¼š
   - Go: ä½¿ç”¨ `c.Field` ç›´æ¥
   - Python: ä½¿ç”¨ `field_expr = self._get_field_expression(c.field)` å¤„ç†
   - âœ… **Python æ›´å®Œå–„**

**å»ºè®®ï¼š**
- åœ¨ `GroupHandler.build_expression()` ä¸­æ·»åŠ å¯¹ `json.loads` çš„å¼‚å¸¸å¤„ç†
- æ•è· `json.JSONDecodeError` å¹¶æŠ›å‡ºæ›´æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯

---

### 2.8 è¡¨è¾¾å¼æ„å»ºçš„æ•´ä½“ç»“æ„å·®å¼‚

#### å·®å¼‚ 4ï¼šNOT æ“ä½œçš„å¤„ç†

**Go ä»£ç ï¼ˆexpr.go:34-47ï¼‰ï¼š**
```go
if c.JoinOp == condition.JoinOpNot {
    if len(c.Conditions) != 1 {
        err = errors.New("invalid condition:not join condition should have only one child")
        return
    }
    if c.Required {
        builder.WriteString("IsNotZero(")
        builder.WriteString(c.Conditions[0].Field)
        builder.WriteString(")")
        builder.WriteString(condition.JoinOpAnd.Code())
    }
    builder.WriteString(c.JoinOp.Code())
    err = expr(c.Conditions[0], builder)
    return
}
```

**Python ä»£ç ï¼ˆexpr.py:36-51ï¼‰ï¼š**
```python
if c.join_op == JoinOp.NOT:
    if len(c.conditions) != 1:
        raise ValueError("invalid condition:not join condition should have only one child")

    if c.required:
        result.append("IsNotZero(")
        field_name = c.conditions[0].field
        if field_name.endswith("()"):  # ç§»é™¤å­—æ®µååçš„()
            field_name = field_name[:-2]
        result.append(field_name)
        result.append(")")
        result.append(JoinOp.AND.code())

    result.append(c.join_op.code())
    self._build_expr(c.conditions[0], result)
    return
```

**å·®å¼‚ç‚¹ï¼š**
- Python ä»£ç åœ¨ NOT æ“ä½œä¸­å¤„ç†äº†å­—æ®µååçš„ `()` åç¼€ï¼ŒGo ä»£ç æ²¡æœ‰
- âœ… **Python å®ç°æ›´å®Œå–„**

---

## ä¸‰ã€å…³é”®å»ºè®®æ€»ç»“

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

1. **TimeBeforeHandler å’Œ TimeAfterHandler ç¼ºå°‘ period_unit éªŒè¯**
   - **ä½ç½®**ï¼š`expr/value_handle/time_before_handler.py` å’Œ `expr/value_handle/time_after_handler.py`
   - **å»ºè®®**ï¼šåœ¨ `build_expression` æ–¹æ³•å¼€å§‹æ—¶æ·»åŠ éªŒè¯é€»è¾‘
   - **å‚è€ƒ**ï¼šGo ä»£ç çš„éªŒè¯é€»è¾‘ï¼ˆexpr.go:181-184, 195-198ï¼‰

2. **GroupHandler ç¼ºå°‘ JSON è§£æé”™è¯¯å¤„ç†**
   - **ä½ç½®**ï¼š`expr/value_handle/group_handler.py:22`
   - **å»ºè®®**ï¼šæ·»åŠ  try-except å—å¤„ç† `json.loads` å¯èƒ½çš„å¼‚å¸¸
   - **å‚è€ƒ**ï¼šGo ä»£ç çš„é”™è¯¯å¤„ç†ï¼ˆexpr.go:230-233ï¼‰

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®æ”¹è¿›ï¼‰

3. **ç¡®è®¤ period_unit çš„å€¼æ ¼å¼**
   - **é—®é¢˜**ï¼šGo ä»£ç ä½¿ç”¨ `c.PeriodUnit.Code()`ï¼ŒPython ç›´æ¥ä½¿ç”¨ `c.period_unit`
   - **å»ºè®®**ï¼šç¡®è®¤ Python ä¸­çš„ `period_unit` æ˜¯å¦å·²ç»æ˜¯æ­£ç¡®çš„ä»£ç å€¼
   - **å¦‚æœä¸åŒ**ï¼šéœ€è¦åˆ›å»º PeriodUnit æšä¸¾ç±»æˆ–æ·»åŠ è½¬æ¢é€»è¾‘

4. **ç»Ÿä¸€å­—æ®µå¤„ç†æ–¹å¼**
   - **ç°çŠ¶**ï¼šPython ä»£ç åœ¨å¤šä¸ª Handler ä¸­ä½¿ç”¨ `_get_field_expression()` æ–¹æ³•
   - **å»ºè®®**ï¼šç¡®ä¿æ‰€æœ‰ Handler éƒ½ä½¿ç”¨æ­¤æ–¹æ³•å¤„ç†å­—æ®µåï¼ˆç›®å‰ BICrowdHandler å’Œ GroupHandler å·²ä½¿ç”¨ï¼Œå…¶ä»– Handler ä¹Ÿåº”ç»Ÿä¸€ï¼‰

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

5. **é”™è¯¯æ¶ˆæ¯çš„ä¸€è‡´æ€§**
   - **å»ºè®®**ï¼šç¡®ä¿ Python ä»£ç ä¸­çš„é”™è¯¯æ¶ˆæ¯æ ¼å¼ä¸ Go ä»£ç ä¿æŒä¸€è‡´
   - **å½“å‰çŠ¶æ€**ï¼šåŸºæœ¬ä¸€è‡´ï¼Œä½†å¯ä»¥è¿›ä¸€æ­¥ç»Ÿä¸€

6. **ä»£ç æ³¨é‡Š**
   - **å»ºè®®**ï¼šä¸ºå…³é”®é€»è¾‘æ·»åŠ æ³¨é‡Šï¼Œè¯´æ˜ä¸ Go ä»£ç çš„å¯¹åº”å…³ç³»

---

## å››ã€ä»£ç è´¨é‡å¯¹æ¯”

### Python é¡¹ç›®çš„ä¼˜åŠ¿

1. âœ… **æ›´å¥½çš„å­—æ®µå¤„ç†**ï¼šä½¿ç”¨ `_get_field_expression()` ç»Ÿä¸€å¤„ç†å­—æ®µå
2. âœ… **æ›´æ¸…æ™°çš„ä»£ç ç»“æ„**ï¼šä½¿ç”¨ Handler æ¨¡å¼ï¼ŒèŒè´£åˆ†ç¦»æ›´æ˜ç¡®
3. âœ… **æ›´å¥½çš„æ‰©å±•æ€§**ï¼šé€šè¿‡ HandlerFactory å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„å¤„ç†å™¨

### Go é¡¹ç›®çš„ä¼˜åŠ¿

1. âœ… **æ›´å®Œå–„çš„é”™è¯¯å¤„ç†**ï¼šå¯¹ period_unit å’Œ JSON è§£æéƒ½æœ‰éªŒè¯
2. âœ… **æ›´ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥**ï¼šGo çš„ç±»å‹ç³»ç»Ÿæä¾›ç¼–è¯‘æ—¶æ£€æŸ¥

---

## äº”ã€å®æ–½å»ºè®®ï¼ˆæš‚ä¸ä¿®æ”¹ä»£ç ï¼‰

### é˜¶æ®µ 1ï¼šéªŒè¯å’Œç¡®è®¤
1. ç¡®è®¤ Python é¡¹ç›®ä¸­ `period_unit` çš„å€¼æ ¼å¼æ˜¯å¦ä¸ Go é¡¹ç›®ä¸€è‡´
2. æ£€æŸ¥æ˜¯å¦æœ‰ period ç›¸å…³çš„æ¨¡å—æˆ–å¸¸é‡å®šä¹‰
3. æµ‹è¯•ç°æœ‰çš„ TimeBeforeHandler å’Œ TimeAfterHandler æ˜¯å¦æ­£å¸¸å·¥ä½œ

### é˜¶æ®µ 2ï¼šè¡¥å……éªŒè¯é€»è¾‘
1. åœ¨ TimeBeforeHandler å’Œ TimeAfterHandler ä¸­æ·»åŠ  period_unit éªŒè¯
2. åœ¨ GroupHandler ä¸­æ·»åŠ  JSON è§£æé”™è¯¯å¤„ç†

### é˜¶æ®µ 3ï¼šç»Ÿä¸€å’Œä¼˜åŒ–
1. ç»Ÿä¸€æ‰€æœ‰ Handler çš„å­—æ®µå¤„ç†æ–¹å¼
2. æ·»åŠ å¿…è¦çš„æ³¨é‡Šå’Œæ–‡æ¡£
3. ç¼–å†™å•å…ƒæµ‹è¯•ç¡®ä¿ä¸ Go ä»£ç è¡Œä¸ºä¸€è‡´

---

## å…­ã€æµ‹è¯•å»ºè®®

å»ºè®®æ·»åŠ ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š

1. **TimeBeforeHandler æµ‹è¯•**ï¼š
   - æµ‹è¯•æ— æ•ˆçš„ period_unit å€¼
   - æµ‹è¯• period_unit ä¸º 0 çš„æƒ…å†µ
   - æµ‹è¯•æ­£å¸¸çš„æ—¶é—´è®¡ç®—

2. **TimeAfterHandler æµ‹è¯•**ï¼š
   - åŒä¸Š

3. **GroupHandler æµ‹è¯•**ï¼š
   - æµ‹è¯•æ— æ•ˆçš„ JSON æ ¼å¼
   - æµ‹è¯•ç©ºæ•°ç»„
   - æµ‹è¯•æ­£å¸¸çš„åˆ†ç»„å€¼

4. **è·¨è¯­è¨€ä¸€è‡´æ€§æµ‹è¯•**ï¼š
   - ä½¿ç”¨ç›¸åŒçš„è¾“å…¥æ¡ä»¶ï¼Œå¯¹æ¯” Go å’Œ Python ç”Ÿæˆçš„è¡¨è¾¾å¼å­—ç¬¦ä¸²
   - ç¡®ä¿è¾“å‡ºå®Œå…¨ä¸€è‡´

---

## ä¸ƒã€æ€»ç»“

Python é¡¹ç›®çš„ value_handle å®ç°æ•´ä½“ä¸Šä¸ Go é¡¹ç›®ä¿æŒä¸€è‡´ï¼Œä¸»è¦å·®å¼‚åœ¨äºï¼š

1. **ç¼ºå°‘éªŒè¯é€»è¾‘**ï¼šTimeBeforeHandlerã€TimeAfterHandler å’Œ GroupHandler éœ€è¦è¡¥å……é”™è¯¯å¤„ç†
2. **period_unit å¤„ç†æ–¹å¼**ï¼šéœ€è¦ç¡®è®¤å€¼æ ¼å¼æ˜¯å¦ä¸€è‡´
3. **ä»£ç è´¨é‡**ï¼šPython å®ç°åœ¨æŸäº›æ–¹é¢ï¼ˆå¦‚å­—æ®µå¤„ç†ï¼‰æ›´å®Œå–„

å»ºè®®ä¼˜å…ˆä¿®å¤é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼Œç¡®ä¿ä¸¤ä¸ªé¡¹ç›®çš„åŠŸèƒ½å®Œå…¨ä¸€è‡´ã€‚

